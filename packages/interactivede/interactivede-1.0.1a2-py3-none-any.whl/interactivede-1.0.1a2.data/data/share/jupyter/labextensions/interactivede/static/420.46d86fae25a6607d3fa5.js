"use strict";(self.webpackChunkinteractivede=self.webpackChunkinteractivede||[]).push([[420],{5681:(e,t,n)=>{n.r(t),n.d(t,{default:()=>et});var a=n(1919),r=n(2952);function s(e){return"object"==typeof e?`<pre>${JSON.stringify(e,null,2)}</pre>`:e}class i{static get changed(){return this.events.changed}static log(e,t){const{data:n=null,level:a="info"}=t||{};this.events.push({type:"html",level:a,date:(new Date).toISOString(),event:e,extra:n,data:`${e}${n?` <strong>:</strong> ${s(n)}`:""}`})}static print(e=!0){e?console.table(this.events):console.log({logEvents:this.events})}}i.events=new r.ObservableList({values:[{type:"html",level:"info",date:(new Date).toISOString(),data:"Initialized Logging",event:"Initialized Logging"}]});var o=n(4616),c=n(7930);class l{constructor(){this._ctx=null}static init(e){this._exec.init(e)}static execute(e){return this._exec.execute(e)}init(e){e.currentChanged.connect((async(e,t)=>{t&&(i.log(`Kernel changed to notebook: ${t.title.label}`),this._ctx=t.sessionContext)}))}async execute(e){const t=this._ctx?.session?.kernel;if(!t)throw new Error("Session ctx probably not set. `init` function should be called before `execute`");return new Promise((n=>{if(!t)return void n({status:"error",err:new Error("No kernel found")});const a={status:"ok",content:[]},r=t.requestExecute({code:e,stop_on_error:!0,store_history:!1});r.onIOPub=e=>{const t=e.header.msg_type,n=e.content;let r="";switch(t){case"execute_result":case"display_data":case"update_display_data":r+=n.data["text/plain"]||"";break;case"stream":r+=n.text}a.content.push(...r.split("\n").filter((e=>e.length>0)))},r.done.then((e=>{const t=e.content.status;n("ok"!==t?{status:t,err:e.content}:a)})).catch((e=>{console.warn("Execution failed",e),n({status:"error",err:e})}))}))}}l._exec=new l,function(e){e.withIDE=function(e){return`import interactivede.ide as IDE\n${e}`},e.withJson=function(e){return`import json\n${e}`},e.withPandas=function(e){return`import pandas as pd\n${e}`}}(l||(l={}));var d=n(2850),u=n(4901),h=n(5350),g=n(8449),p=n(6128);function m(e,t=e.current){const n=[],a=e.trrack.graph.backend.nodes;let r=a[t];for(;!(0,p.isRootNode)(r);)n.push(r.id),r=a[r.parent];return n.push(e.trrack.root.id),n.reverse(),n.map((e=>a[e])).map((t=>e.trrack.getState(t)))}class _{}async function f(e,t){const{result:n,dfName:a}=await v(e,t);return await async function(e){return await navigator.clipboard.writeText(e)}(a),function(e){h.Notification.emit(`Copied code for df: ${e}`,"success",{autoClose:500})}(a),n}async function v(e,t){const n=e.trrackManager.trrack,a=_.vegaManager.get(e);if(!a)throw new Error("Vega view not found");const r=t||n.root.id,s=m(e.trrackManager,t||n.current.id),i=a.view.getState({data:e=>!!e&&e.startsWith("source_"),signals:()=>!1}),o=Object.keys(i.data);if(1!==o.length)throw new Error("incorrect dataset. start with source_");const c=i.data[o[0]],d=function(e,t){const{prefix:n="",suffix:a=""}=t||{};return(0,g.varName)([n,e,a].join(" ").trim())}(r.substring(0,5),{prefix:"df",suffix:t?"":"dyn"}),u=await l.execute(function(e,t,n){console.log({data:w(t),interactions:w(n)});return l.withIDE(`\n${e} = IDE.create_dataframe(${w(t)}, ${w(n)})\nprint(${e})\n${e}\n`)}(d,c,s));return console.log(u),{result:u,dfName:d}}function w(e){return JSON.stringify(JSON.stringify(e))}_.cells=new Map,_.vegaManager=new WeakMap,_.cellUpdateStatus=new WeakMap,_.Datasets={counter:{selection:-1,filter:-1,root:-1},datasetStatusMap:new Map},window.IDEGlobal=_;class y{constructor(){this._isDisposed=!1}get isDisposed(){return this._isDisposed}set isDisposed(e){this._isDisposed=e}}var k,C=n(5103);function S(){return(0,C.v4)()}function b(e){return"function"==typeof e?e():e}async function x(e,t,n){return Promise.resolve(e.apply(t,n))}function E(e){const t=p.Registry.create(),n=t.register("interaction",((e,t)=>t));let a=(0,p.initializeTrrack)({registry:t,initialState:{id:S(),type:"create"}});return e&&"string"==typeof e?a.import(e):e&&"string"!=typeof e&&(a=(0,p.initializeTrrack)({registry:t,initialState:e})),{trrack:a,actions:{addSelection:async(e,t="Brush Selection")=>await x(a,b(t),n(e)),addFilter:async(e,t="Filter")=>await x(a,b(t),n(e)),addAggregate:async(e,t="Aggregate")=>await x(a,b(t),n(e))}}}class L{static create(e){return E(e)}}!function(e){e.create=function(e){return E(e)}}(k||(k={}));const I="trrack_graph";class M extends y{constructor(e){super(),this._cell=e,this._trrackInstanceChange=new u.Signal(this),this._trrackCurrentChange=new u.Signal(this);const{trrack:t,actions:n}=this._reset(!0);this._trrack=t,this._actions=n,this.currentChange.connect((async()=>{await v(e)}))}get savedGraph(){const e=this._cell.model.getMetadata(I);return"string"==typeof e?e:JSON.stringify(e)}get hasSelections(){const e=this._cell.trrackManager.trrack.getState();if("selection"===e.type){const{value:t}=e;return!!t}return!1}get trrack(){return this._trrack}get actions(){return this._actions}get isAtRoot(){return this.current===this.root}get isAtLatest(){return 0===this._trrack.current.children.length}get hasOnlyRoot(){return 0===this._trrack.root.children.length}get changed(){return this._trrackInstanceChange}get currentChange(){return this._trrackCurrentChange}get root(){return this._trrack.root.id}get current(){return this._trrack.current.id}_cleanUpDatasets(){const e=this._trrack.graph.backend.nodes;Object.keys(e).forEach((e=>{_.Datasets.datasetStatusMap.delete(e)}))}_reset(e){this._trrack&&this._cleanUpDatasets(),this.currentChange.disconnect(this._saveTrrackGraphToModel,this);const{trrack:t,actions:n}=L.create(e?this.savedGraph:void 0);return this._trrack=t,this._actions=n,this._saveTrrackGraphToModel(),this._trrack.currentChange((e=>{this._trrackCurrentChange.emit({trigger:e,currentNode:this._trrack.current.id,state:this._trrack.getState()})})),this.currentChange.connect(this._saveTrrackGraphToModel,this),this._trrackInstanceChange.emit(this._trrack.root.id),this._trrackCurrentChange.emit({trigger:"reset",currentNode:this._trrack.current.id,state:this._trrack.getState()}),{trrack:t,actions:n}}_saveTrrackGraphToModel(){this._cell.model.setMetadata(I,JSON.parse(this._trrack.export()))}reset(){this._reset(!1)}dispose(){this.isDisposed||(this.isDisposed=!0,u.Signal.clearData(this))}}const R=o.VEGALITE5_MIME_TYPE,T="trrack_execution_spec";class A extends d.CodeCell{constructor(e){super(e),this.warnings=[],this._trrackManager=new M(this),this.model.outputs.fromJSON(this.model.outputs.toJSON()),this.model.outputs.changed.connect(this._outputChangeListener,this),i.log(`Created TrrackableCell ${this.cellId}`)}dispose(){this.isDisposed||(u.Signal.clearData(this),_.cells.delete(this.cellId),this._trrackManager.dispose(),super.dispose())}get cellId(){return this.model.id}get trrackId(){return this._trrackManager.root}get trrackManager(){return this._trrackManager}get executionSpec(){return this.model.getMetadata(T)}addSpecToMetadata(e){"execute"===_.cellUpdateStatus.get(this)&&this.model.setMetadata(T,e)}updateVegaSpec(e){const t=this.model.outputs.toJSON().findIndex((e=>"execute_result"===e.output_type));if(-1===t)return;const n=this.model.outputs.get(t);"execute_result"===n.type&&(_.cellUpdateStatus.set(this,"update"),n.setData({data:{[R]:e}}))}_outputChangeListener(e,t){const{type:n,newIndex:a}=t;if("add"!==n)return;const r=e.get(a),s=r.metadata;"execute_result"!==r.type||s.cellId||(_.cellUpdateStatus.set(this,"execute"),r.setData({metadata:{cellId:this.cellId}}))}}!function(e){e.create=function(t){const n=new e(t);return _.cells.set(n.cellId,n),n},e.isTrrackableCell=function(t){return t instanceof e}}(A||(A={}));var D=n(4470),N=n(8778),O=n(6029),P=n.n(O),U=n(1654),W=n(4017),j=n(7704),V=n.n(j),$=n(2189);function H(e){return P().createElement("div",{onClick:e=>e.stopPropagation(),style:{zIndex:100,display:"flex",flexDirection:"row"}},P().createElement("button",{className:"bp3-button bp3-minimal jp-ToolbarButtonComponent minimal jp-Button",type:"button",onClick:async t=>{t.preventDefault(),f(e.cell,e.id)}},P().createElement($.copyIcon.react,{tag:"span"})))}function F(e){const{cell:t}=e,n=t.trrackManager,{trrack:a}=n,[r,s]=(0,O.useState)(a.current.id),i=(0,O.useRef)(null),{verticalSpace:o,marginTop:c,gutter:l}={verticalSpace:25,marginTop:25,gutter:25};return(0,O.useEffect)((()=>{const e=(e,{currentNode:t})=>{s(t)};return n.currentChange.connect(e),n.trrack.to(n.current),()=>{n.currentChange.disconnect(e)}}),[n]),(0,O.useEffect)((()=>{const e=i.current;if(!e)return;const n=(0,W.Z)(e).selectAll(".node-description").selectAll(".extract-btn").data([null]).join("div").classed("extract-btn",!0),a=[];return n.each((function(){const e=this;if(!e)return;const n=(0,W.Z)(e.parentElement).attr("data-node-id");a.push((()=>V().unmountComponentAtNode(e))),V().render(P().createElement(H,{cell:t,id:n}),e)})),()=>a.forEach((e=>e()))})),P().createElement("div",null,P().createElement("div",null,"Controls"),P().createElement("div",{ref:i},P().createElement(U.ProvVis,{root:a.root.id,config:{changeCurrent:e=>{a.to(e)},labelWidth:100,verticalSpace:o,marginTop:c,marginLeft:15,gutter:l,animationDuration:200,annotateNode:null},nodeMap:a.graph.backend.nodes,currentNode:r})))}function J(e){return P().createElement(h.UseSignal,{signal:e.cellChange},((e,t)=>t?P().createElement(F,{cell:t}):null))}class B extends h.ReactWidget{constructor(){super(...arguments),this._cell=null,this._cellChange=new u.Signal(this)}async tryRender(e){this.show(),this.render(),await this.renderPromise;const t=_.cells.get(e);if(!t)throw new Error("Cell not found");t!==this._cell&&(this._cell=t,this._cellChange.emit(this._cell))}render(){return P().createElement(J,{cellChange:this._cellChange})}}const z="jp-OutputHeaderWidget-btn";function G(e){const{commands:t,cId:n}=e;return t.hasCommand(n)?P().createElement(h.UseSignal,{signal:t.commandChanged},(()=>P().createElement($.Button,{className:z,disabled:!t.isEnabled(n),onClick:()=>t.execute(n)},t.label(n)))):(console.warn(`Command ${n} not found`),null)}var Y,q=n(7120);!function(e){e.reset="output:reset",e.filter="output:filter",e.aggregate="output:aggregate",e.copyDynamic="output:copy-dynamic"}(Y||(Y={}));class K{constructor(e){this._cell=e,this._commands=new q.CommandRegistry,this._cell&&this._setup()}get commands(){return this._commands}_setup(){this._commands.addCommand(Y.reset,{execute:()=>{this._cell.trrackManager.reset()},isEnabled:()=>!this._cell.trrackManager.hasOnlyRoot,label:"Reset"}),this._commands.addCommand(Y.filter,{execute:()=>{!async function(e,t="out"){await e.trrackManager.actions.addFilter({id:c.UUID.uuid4(),type:"filter",direction:t})}(this._cell)},isEnabled:()=>this._cell.trrackManager.hasSelections,label:"Filter"}),this._commands.addCommand(Y.aggregate,{execute:()=>{!async function(e){const t=c.UUID.uuid4();await e.trrackManager.actions.addAggregate({id:t,agg_name:`Agg_${t.split("-")[0]}`,type:"aggregate"})}(this._cell)},isEnabled:()=>this._cell.trrackManager.hasSelections,label:"Aggregate"}),this._commands.addCommand(Y.copyDynamic,{execute:()=>{f(this._cell)},label:"Create Dynamic Dataframe",caption:"Generate variable which has the dataframe for current provenance node"}),this._cell.trrackManager.currentChange.connect(((e,t)=>{this._commands.notifyCommandChanged()}))}}const Z=[Y.reset,Y.filter,Y.aggregate,Y.copyDynamic];function Q({cell:e}){if(!e)return P().createElement("div",null,"Something");const t=new K(e);return P().createElement(P().Fragment,null,Z.map((e=>P().createElement(G,{commands:t.commands,cId:e}))))}function X({signal:e}){return P().createElement(h.UseSignal,{signal:e},((e,t)=>P().createElement(Q,{cell:t})))}class ee extends h.ReactWidget{constructor(){super(),this._cellChange=new u.Signal(this),this._cell=null,this.addClass("jp-OutputHeaderWidget")}async associateCell(e){this.show(),this.render(),await this.renderPromise;const t=_.cells.get(e);if(!t)throw new Error("Cell not found");t!==this._cell&&(this._cell=t,this._cellChange.emit(this._cell))}toggle(){return this.isHidden?this.show():this.hide(),this.isHidden}render(){return this.show(),P().createElement(X,{signal:this._cellChange})}}class te extends D.RenderedCommon{constructor(e){super(e),this.outputHeaderWidget=new ee,this.outputArea=new N.Panel,this.trrackVisWidget=new N.Panel,this.layout=this._panelLayout=new N.PanelLayout,this.addClass("lm-Panel"),this.addClass("jp-trrack-OutputArea-output"),this._setupOutputHeaderWidget(),this._createRenderer=()=>this.createRenderer(e),this._executeResultRenderer=this._createRenderer(),this._setupExecuteResultWidget(),this._trrackVisRenderer=new B,this._setupTrrackWidget(),this._panelLayout.addWidget(this.outputHeaderWidget),this._panelLayout.addWidget(this.outputArea),this._panelLayout.addWidget(this.trrackVisWidget)}get executeResultRenderer(){return this._executeResultRenderer}_setupOutputHeaderWidget(){this.outputHeaderWidget.addClass("jp-gridArea-OutputArea-head")}_setupExecuteResultWidget(){this.outputArea.id="regular",this.outputArea.addClass("jp-gridArea-OutputArea-output"),this.outputArea.addClass("jp-trrack-OutputArea-executeResult"),this.outputArea.addClass("jp-OutputArea-output"),this.outputArea.addClass("enable-scroll")}_setupTrrackWidget(){this.trrackVisWidget.id="trrack",this.trrackVisWidget.addClass("jp-gridArea-OutputArea-trrack"),this.trrackVisWidget.addClass("jp-trrack-OutputArea-trrack"),this.trrackVisWidget.addWidget(this._trrackVisRenderer)}async renderModel(e){this.toggleClass("jp-mod-trusted",e.trusted),await this.render(e);const{fragment:t}=e.metadata||{};t&&this.setFragment(t)}async render(e){const t=this._createRenderer(),n=await t.renderModel(e);if(!this.outputArea.layout)return n;for(;this.outputArea.widgets.length>0;)this.outputArea.layout.widgets[0].dispose(),this.outputArea.layout.removeWidgetAt(0);this.outputArea.node.textContent="",this.outputArea.addWidget(t),this._executeResultRenderer.dispose(),this._executeResultRenderer=t;const a=e.metadata?.cellId;a||(console.warn("Cell id not found in metadata for following element. Consider not using RenderedTrrackOutput"),console.warn(this.node));const r=a?_.cells.get(a):null;return a&&r&&this._trrackVisRenderer?(await this.outputHeaderWidget.associateCell(a),await this._trrackVisRenderer.tryRender(a),await this.postRender(r)):(this.outputHeaderWidget.hide(),this._trrackVisRenderer?.hide()),n}dispose(){super.dispose(),this._executeResultRenderer.dispose(),this._trrackVisRenderer.dispose(),this.outputHeaderWidget.dispose()}}var ne=n(8963),ae=(n(5746),n(2017)),re=n(41),se=n(4439),ie=n(9418),oe=n(3586),ce=n(1341);function le(e){return JSON.parse(JSON.stringify(e))}function de(e){const{select:t}=e;return"string"==typeof t?"interval"===t:"interval"===t.type}function ue(e){return delete e.value,e}class he{static init(e,t=this.DEFAULT_UNIT_SPEC_JSON_PATH){return new he(e,t)}constructor(e,t){this._PATH=he.DEFAULT_UNIT_SPEC_JSON_PATH,this._viewLayerSpecs=[],this._layerFns=new Map,this._topLevel={},this._rawSpec=le(e),this._baseSpec=le(e);const n=["name","mark","encoding","view","projection","transform","width","height"],a=(0,se.omit)(le(this._rawSpec),n);if(this._topLevel={...this._topLevel,...a},this._PATH=t,this._isUnitSpec){const e=(0,se.pick)(le(this._rawSpec),n),t=e.name||S();e.name=t,a.params?.forEach((e=>{if((0,ne.wY)(e)){const{views:n=[]}=e;e.views=[...n,t]}})),this._baseSpec={...le(a),layer:[e]}}if((0,re.JSONPath)({json:this._baseSpec,path:this._PATH,resultType:"all"}).forEach((e=>{const{value:t,pointer:a}=e;if(!(0,oe.Gw)(t))throw new Error("Should not enter here.");const r=(0,se.omit)(t,n);this._topLevel={...this._topLevel,...r};const s={base:(0,se.pick)(t,n),spec:{layer:[]},path:a};this._viewLayerSpecs.push(s)})),this._normalizedBaseSpec=(0,ie.F)(le(this._rawSpec)),(0,ce.o)(this._normalizedBaseSpec)){const e=((0,ce.D4)(this._normalizedBaseSpec)?this._normalizedBaseSpec.concat[0]:(0,ce.z_)(this._normalizedBaseSpec)?this._normalizedBaseSpec.vconcat[0]:this._normalizedBaseSpec.hconcat[0]).name;this.updateTopLevelParameter((t=>{if(!e)return t;if(n=t,(0,ne.wY)(n)&&"views"in n){let{views:n=[]}=t;const a=n.length;n=n.filter((t=>t.includes(e))),n.length<a&&console.warn("disabled brushing on all views except first"),t.views=n}var n;return t}))}}get views(){return this._viewLayerSpecs.map((e=>e.base))}get _isUnitSpec(){return(0,oe.Gw)(this._rawSpec)}get unitSpecJSONPath(){return this._PATH}get originalSpec(){return this._rawSpec}get baseSpec(){return this._baseSpec}get spec(){return this._process()}get params(){return this._baseSpec.params||(this._baseSpec.params=[]),this._baseSpec.params}set params(e){this._baseSpec.params=e}updateTopLevelParameter(e=(e=>e)){this.params=this.params.map((t=>e(t)))}addLayer(e,t=(e=>e)){const n=this._layerFns.get(e)||[];this._layerFns.set(e,[...n,t])}_process(){0===this._layerFns.size&&this.addLayer("BASE");const e=this._viewLayerSpecs.map((e=>{const t=le(e),{base:n}=t;return this._layerFns.forEach((e=>{const a=e.reduce(((e,t)=>t(e)),le(n));t.spec.layer.push(a)})),t})),t=[];e.forEach((({path:e,spec:n})=>{t.push({op:"replace",path:e,value:n})}));const n=(0,ae.immutableJSONPatch)(le(this._baseSpec),le(t)),a={...this._topLevel,...n};if(this._isUnitSpec){const e=a,t=e.layer;if(1===t.length){const n=t[0];if((0,oe.a3)(n)){const t=n.layer;e.layer=t}}}return a}}he.DEFAULT_UNIT_SPEC_JSON_PATH='$..*[?(@property==="mark")]^';var ge=n(7422),pe=n(8666);function me(...e){return e.reduce(((e,t)=>n=>t(e(n))))}var _e=n(640);function fe(e){return(0,_e.Ts)(e)}function ve(e,t,n){return e=e||{},{...e,[t]:n}}function we(e,t){return delete(e=e||{})[t],e}var ye=n(2343),ke=n(1644),Ce=n(1066);function Se(e){return"object"!=typeof e?[]:Object.entries(e).map((([e,t])=>({key:e,value:t})))}const be="__OUT_FILTER_LAYER__",xe="__NON_NULL_FORCE_STRING__";function Ee(e,t){const{transform:n=[]}=e,a={filter:t};return n.push(a),e.transform=n,e}function Le(e){return e.map((e=>function(e){const t=e.value,n=[];if(function(e){const t=typeof e;return"number"===t||"string"===t||"boolean"===t}(t)||(0,ye.v9)(t))throw new Error(`Cannot handle: ${t}`);if((0,se.isArray)(t)){const e=t.map(Me).flat();n.push(...e)}else if("object"==typeof t){const r=function(e){return Se(e).map((({key:e,value:t})=>({field:e,range:t})))}(t),s=de(e)?[(a=r,{and:a})]:r;n.push(...s)}var a;return n}(e))).flat()}function Ie(e){return(0,ke.Tv)(e)?e.not:{not:e}}function Me(e){return Se(e).map((({key:e,value:t=xe})=>({field:e,equal:t})))}function Re(e){return{or:e}}var Te=n(3261);function Ae(e){return e.name&&delete e.name,e}function De(e){const{transform:t=[]}=e;return e.transform=t.filter((e=>!(0,Te.nK)(e)||!(0,Ce.AW)(e.filter))),e}function Ne(e){return e.params&&(e.params=e.params.filter((e=>!(0,ne.wY)(e)))),e}function Oe(e,t=""){return 0===t.length?e:`${e}_${t}`}function Pe(e){return(0,pe.QD)(e)?e.type:((0,pe.c_)(e),e)}function Ue(e){const t=[],n=Pe(e.mark);return(0,pe.hx)(n),(0,pe.io)(n),(0,pe.c_)(n)&&fe(e.encoding||{}).forEach((e=>{const{field:n,aggregate:a}=e;let r=null;(0,ge.tV)(e)&&(r=e.type),!n||(0,ge.Ze)(n)||a||"quantitative"!==r||t.push({field:n,as:n,op:"mean"})})),t}class We{constructor(e,t){this.interactions=e,this._id=t}apply(e){const t=he.init(e);return this.interactions.forEach((e=>{this.applyInteraction(t,e)})),t.spec}applyInteraction(e,t){switch(t.type){case"selection":this.applySelection(e,t);break;case"filter":e=function(e,t){const{direction:n}=t,a=be,{params:r}=e,s=Re(Le(r.filter(ne.wY)));return e.updateTopLevelParameter((e=>(0,ne.wY)(e)?ue(e):e)),e.addLayer(a,(e=>Ee(e,"out"===n?Ie(s):s))),e}(e,t),console.log(e.spec);break;case"aggregate":e=function(e,t){const{params:n=[]}=e,a=Ie(Re(Le(n.filter(ne.wY))));e.updateTopLevelParameter((e=>(0,ne.wY)(e)?ue(e):e));const r=be;e.addLayer(r,(e=>Ee(e,a)));const s=Ie(a),i=Oe(t.agg_name,"__IN_FILTER_LAYER__");e.addLayer(i,(e=>function(e,t){const n=Pe((e=Ee(e,t)).mark);return e.encoding=ve(e.encoding,"fillOpacity",{value:.2}),e.encoding=ve(e.encoding,"strokeOpacity",{value:.8}),e.encoding=ve(e.encoding,"opacity",{value:.2}),(0,pe.hx)(n)||(0,pe.io)(n)||(0,pe.c_)(n),me(Ae,Ne,De)(e)}(e,s)));const o=Oe(t.agg_name,"AGG");return e.addLayer(o,(e=>function(e,t,n){e=Ee(e,t);const{transform:a=[]}=e;e.encoding=we(e.encoding,"opacity");const r=Pe(e.mark);(0,pe.hx)(r),(0,pe.io)(r)&&(e.encoding=we(e.encoding,"opacity")),(0,pe.c_)(r)&&(e.encoding=we(e.encoding,"fillOpacity"),e.encoding=we(e.encoding,"strokeOpacity"),(0,pe.io)(r)||(e.encoding=ve(e.encoding,"size",{value:400})));const s={joinaggregate:Ue(e)},i=function(e,t){const n=[],a=Pe(e.mark);return(0,pe.hx)(a),(0,pe.io)(a),(0,pe.c_)(a)&&fe(e.encoding||{}).forEach((e=>{const{field:a}=e;let r=null;(0,ge.tV)(e)&&(r=e.type),a&&!(0,ge.Ze)(a)&&"nominal"===r&&n.push({calculate:t,as:a})})),n}(e,`"${n.agg_name}"`);return a.push(s),a.push(...i),e.transform=a,me(Ae,Ne,De)(e)}(e,s,t))),e}(e,t),console.log(e.spec)}}applySelection(e,t){e.updateTopLevelParameter((e=>((0,ne.wY)(e)&&e.name===t.name&&(e.value=t.value),e)))}}We.cache=new Map;class je extends y{constructor(e,t,n){super(),this._view=e,this._id=t,this._listener=n,this.add()}pause(){return this.remove(),this}resume(){if(this.isDisposed)throw new Error(`Handler for ${this._id} is disposed`);return this.add(),this}dispose(){this.isDisposed||(this.isDisposed=!0,this.remove())}}class Ve extends je{constructor(e,t,n){super(e,t,n)}add(){return this._view.addSignalListener(this._id,this._listener),this}remove(){return this._view.removeSignalListener(this._id,this._listener),this}}class $e extends je{constructor(e,t,n){super(e,t,n)}add(){return this._view.addEventListener(this._id,this._listener),this}remove(){return this._view.removeEventListener(this._id,this._listener),this}}function He(e){return e?(0,se.isArray)(e)&&0===e.length?"Clear selection":"Brush selection":"Clear selection"}class Fe extends y{constructor(e,t){super(),this._cell=e,this._vega=t,this._listeners={selection:new Set},this._tManager.currentChange.connect(((e,t)=>{this.update()}),this),this._processVegaSpec()}update(){const e=le(this._cell.executionSpec);if(!e)throw new Error("No execution spec found for cell");const t=m(this._tManager),n=new We(t,this._cellId).apply(e);this._cell.updateVegaSpec(n)}dispose(){this.isDisposed||(this.isDisposed=!0,this.removeListeners(),this.view.finalize(),u.Signal.disconnectAll(this))}get _cellId(){return this._cell.cellId}get _tManager(){return this._cell.trrackManager}get hasVega(){return!!this.view}get vega(){return this._vega}get view(){return this._vega.view}get spec(){return this._vega.spec}_processVegaSpec(){this.addListeners()}addListeners(){this.addSelectionListeners()}addSelectionListeners(){this.removeSelectionListeners();const{params:e=[]}=this.spec;e.filter(ne.wY).forEach((e=>{const{views:t=[],bind:n}=e;if((0,ne.d4)(n)||0!==t.length)if(de(e)){const n=function({manager:e,selector:t,trrackManager:n,cellId:a}){const{view:r}=e;if(!_.cells.get(a))throw new Error("Cell doesn't exist");let s=null,i=!1;return{handleSignalChange:function(e){i=!0,s=r.signal(t.name)},handleBrushEnd:async function(e,a){if(!i)return;0===Object.keys(s).length&&(s=null),i=!1;const r={...t,type:"selection",id:c.UUID.uuid4(),value:s};await n.actions.addSelection(r,(()=>He(s)))}}}({manager:this,selector:e,views:t,trrackManager:this._tManager,cellId:this._cell.cellId});this._listeners.selection.add(new Ve(this.view,e.name,(e=>{n.handleSignalChange(e)}))),this._listeners.selection.add(new $e(this.view,"mouseup",n.handleBrushEnd))}else if(function(e){const{select:t}=e;return"string"==typeof t?"point"===t:"point"===t.type}(e)){const n=function({manager:e,selector:t,trrackManager:n,cellId:a}){const{view:r}=e;if(!_.cells.get(a))throw new Error("Cell doesn't exist");let s;return{handleSignalChange:async function(e){s=r.signal(t.name)?.vlPoint?.or||[];const a={...t,id:c.UUID.uuid4(),type:"selection",value:s};await n.actions.addSelection(a,(()=>He(s)))}}}({manager:this,selector:e,views:t,trrackManager:this._tManager,cellId:this._cell.cellId});this._listeners.selection.add(new Ve(this.view,e.name,n.handleSignalChange))}else console.log("legend",e)}))}removeListeners(){this.removeSelectionListeners()}removeSelectionListeners(){this._listeners.selection.forEach((e=>e.dispose()))}}!function(e){e.create=function(t,n){const a=new e(t,n),r=_.vegaManager.get(t);return r&&r.dispose(),_.vegaManager.set(t,a),a}}(Fe||(Fe={}));class Je extends te{constructor(e){super(e),this._id=Math.random()}createRenderer(e){return new o.RenderedVega(e)}dispose(){super.dispose(),this._unsafeVegaAccess&&this._vega.view.finalize()}postRender(e){const t=Fe.create(e,this._vega);return e.addSpecToMetadata(this.spec),"execute"===_.cellUpdateStatus.get(e)&&t.update(),Promise.resolve()}async renderModel(e){return await super.renderModel(e)}get _unsafeVegaAccess(){return Boolean(this.executeResultRenderer?._result)}get _vega(){if(!this._unsafeVegaAccess)throw new Error("Vega object not yet created! Should only be accessed by vega manager created from postRender.");return this.executeResultRenderer?._result}get spec(){return this._vega.spec}}const Be="NB_UUID";class ze{constructor(e){l.init(e),e.currentChanged.connect(((e,t)=>{t&&i.log(`Switched to notebook: ${t?.context.path}`),t?.context.ready.then((()=>{const e=t.context.model.getMetadata(Be);if(e)_.currentNotebook=e;else{const e=c.UUID.uuid4();t.context.model.setMetadata(Be,e),_.currentNotebook=e}})),t?.disposed.connect((()=>{i.log(`Closed notebook: ${t?.context.path}`)}))}))}createNew(e,t){e.content.rendermime.addFactory({...o.rendererFactory,defaultRank:(o.rendererFactory.defaultRank||10)-1,createRenderer:e=>new Je(e)}),e.content,a.NotebookActions.executed.connect(((e,{cell:t,notebook:n})=>{A.isTrrackableCell(t)&&i.log(`Cell ${t.cellId} executed in notebook ${n.id}`)})),a.NotebookActions.executionScheduled.connect(((e,{cell:t})=>{A.isTrrackableCell(t)}))}}const Ge={id:"interactivede:plugin",autoStart:!0,requires:[a.INotebookTracker],activate:function(e,t){e.docRegistry.addWidgetExtension("notebook",new ze(t)),i.log("JupyterLab extension interactivede is activated!")}};var Ye=n(9498);class qe extends a.NotebookPanel.ContentFactory{createCodeCell(e){return A.create(e).initializeState()}}const Ke={id:"interactivede:cell-factory",provides:a.NotebookPanel.IContentFactory,requires:[Ye.IEditorServices],autoStart:!0,activate:(e,t)=>{i.log("Jupyterlab extension interactivede is activated! - cell-factory");const n=new d.Cell.ContentFactory({editorFactory:t.factoryService.newInlineEditor});return new qe(n)}};var Ze=n(4163),Qe=n(9350);class Xe extends h.ReactWidget{constructor(e){super(),this.handleChange=e=>{this._logConsole.logger&&(this._logConsole.logger.level=e.target.value),this.update()},this.handleKeyDown=e=>{13===e.keyCode&&this._logConsole.activate()},this._id=`level-${c.UUID.uuid4()}`,this.addClass("jp-LogConsole-toolbarLogLevel"),this._logConsole=e,this._logConsole.logger.level="debug",e.source&&this.update(),e.sourceChanged.connect(this._updateSource,this)}_updateSource(e,{oldValue:t,newValue:n}){null!==t&&e.loggerRegistry.getLogger(t).stateChanged.disconnect(this.update,this),null!==n&&e.loggerRegistry.getLogger(n).stateChanged.connect(this.update,this),this.update()}render(){const e=this._logConsole.logger;return P().createElement(P().Fragment,null,P().createElement("label",{htmlFor:this._id,className:null===e?"jp-LogConsole-toolbarLogLevel-disabled":void 0},"Log Level:"),P().createElement($.HTMLSelect,{id:this._id,className:"jp-LogConsole-toolbarLogLevelDropdown",onChange:this.handleChange,onKeyDown:this.handleKeyDown,value:e?.level,"aria-label":"Log level",disabled:null===e,options:null===e?[]:["Critical","Error","Warning","Info","Debug"].map((e=>({label:e,value:e.toLowerCase()})))}))}}const et=[Ge,Ke,{id:"interactivede:log-console",autoStart:!0,requires:[h.ICommandPalette,D.IRenderMimeRegistry,Ze.ILayoutRestorer],activate:(e,t,n,a)=>{const{commands:r}=e;let s=null,o=null;const c=new h.WidgetTracker({namespace:"log-console"});a.restore(c,{command:"lg/log-console:open",name:()=>"Log Console"}),r.addCommand("lg/log-console:checkpoint",{execute:()=>s?.logger?.checkpoint(),icon:$.addIcon,isEnabled:()=>!!s&&null!==s.source,label:"Add Checkpoint"}),r.addCommand("lg/log-console:clear",{execute:()=>s?.logger?.clear(),icon:$.clearIcon,isEnabled:()=>!!s&&null!==s.source,label:"Clear Log"}),e.commands.addCommand("lg/log-console:download",{execute:()=>{if(!document)return;const e=[];for(let t=0;t<i.events.length;++t){const n=i.events.get(t),a={event:n.event,date:n.date};n.extra&&(a.extra=n.extra),e.push(a)}const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=document.createElement("a");n.download=`IDE_JP_ext_log_${Date.now()}.json`,n.href=window.URL.createObjectURL(t),n.dataset.downloadUrl=["application/json",n.download,n.href].join(":");const a=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});n.dispatchEvent(a),n.remove()},icon:$.downloadIcon,isEnabled:()=>i.events.length>0,label:"Download Log"}),r.addCommand("lg/log-console:level",{execute:e=>{s?.logger&&(s.logger.level=e.level)},isEnabled:()=>!!s&&null!==s.source,label:e=>`Set Log Level to ${e.level}`}),r.addCommand("lg/log-console:open",{label:"Open Log Console",caption:"Open log console.",isToggled:()=>null!==o,execute:()=>{o?o.dispose():(()=>{s=new Qe.LogConsolePanel(new Qe.LoggerRegistry({defaultRendermime:n,maxLength:1e3})),s.source="IDE Logs",o=new h.MainAreaWidget({content:s}),o.addClass("jp-LogConsole"),o.title.label="Log Console",o.title.icon=$.listIcon,o.toolbar.addItem("checkpoint",new h.CommandToolbarButton({commands:e.commands,id:"lg/log-console:checkpoint"})),o.toolbar.addItem("download",new h.CommandToolbarButton({commands:e.commands,id:"lg/log-console:download"})),o.toolbar.addItem("level",new Xe(o.content));const t=(e,t)=>{"add"===t.type&&t.newValues.forEach((e=>{switch(e.type){case"text":case"output":case"html":s?.logger?.log(e)}}))};o.disposed.connect((()=>{o=null,s=null,i.changed.disconnect(t,void 0),r.notifyCommandChanged()})),e.shell.add(o,"main",{mode:"split-bottom"}),c.add(o);for(let e=0;e<i.events.length;++e){const t=i.events.get(e);switch(t.type){case"text":case"output":case"html":s?.logger?.log(t)}}i.changed.connect(t,void 0),o.update(),r.notifyCommandChanged()})()}}),t.addItem({command:"lg/log-console:open",category:"Log Console"}),r.addCommand("lg/log-console:logHTMLMessage",{label:"HTML log message",caption:"HTML log message.",execute:()=>{s?.logger?.log({type:"html",level:"debug",data:"<div>Hello world HTML!!</div>"})}}),r.addCommand("lg/log-console:logTextMessage",{label:"Text log message",caption:"Text log message.",execute:()=>{s?.logger?.log({type:"text",level:"info",data:"Hello world text!!"})}}),r.addCommand("lg/log-console:logOutputMessage",{label:"Output log message",caption:"Notebook output log message.",execute:()=>{s?.logger?.log({type:"output",level:"warning",data:{output_type:"display_data",data:{"text/plain":"Hello world nbformat!!"}}})}})}}]}}]);